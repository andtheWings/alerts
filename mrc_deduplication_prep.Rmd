---
title: "1 Prepping Datasets for Deduplication and Merging"
author: "Daniel P. Hall Riggins, MD"
date: "9/11/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(arrow)
library(readxl)
library(tidyverse)

```

"MatchingtoMEdata" and "Rectified_FHSP_CC_20201102" do not need any prep

```{r message=FALSE, warning=FALSE}
FHP_raw <- read_xlsx(
    "mrc_data/FHPMatchedtoEMRMatchedtoChante_reduced.xlsx",
    sheet = "EncounterdatawithChante",
    na = "NULL"
)
deaths_raw <- read_xlsx(
    "mrc_data/MatchingtoMEdata.xlsx", 
    na = "NULL"
)
diagnoses_raw <- read_xlsx("mrc_data/Rectified_FHSP_CC_20201102.xlsx", col_types = c("numeric", "text"))
```

```{r functions}
dedupe_prep <- function(source, columns, origin) {
    print(
        paste0(
            "Initial number of records is ",
            nrow(source)
        )
    )
    distinct1 <- distinct(source)
    print(
        paste0(
            "Which reduces to ",
            nrow(distinct1),
            " when disinct() is first run"
        )
    )
    select2 <- select({{distinct1}}, {{columns}})
    distinct3 <- distinct(select2)
    print(
        paste0(
            "Which reduces to ",
            nrow(distinct3),
            " when disinct() is run after selecting columns of interest"
        )
    )
    mutate4 <- mutate(
        distinct3,
        origin = origin
    )
    return(mutate4)
}
```


```{r FHP people prep}
FHP_people <- dedupe_prep(
    source = FHP_raw,
    columns = c(person_id, cmrn_id, rin_cc, NAME_FIRST, NAME_LAST, BIRTH_DT_TM, sex_cd, race, ethnicity),
    origin = "FHPMatchedtoEMRMatchedtoChante_reduced.xlsx"
)

```



```{r init people in dolt}
con <- dbConnect(MariaDB(),
                 dbname = 'mrc_data',
                 host = '127.0.0.1',
                 port = 3306,
                 user = 'root')

dbWriteTable(con, "people", people, overwrite = TRUE)
```
```{r}
read_parquet("mrc_data/people_model/deduped_people.parquet") %>%
    select(1:3, 17:18) %>%
    mutate(across(1:3, as.numeric)) %>%
    full_join(people) %>%
    write_csv("people.csv")





```


```{r}

history_encounters <- history_raw %>%
    # 145490 observations
    #distinct() %>%
    # No change
    select(
        !c(BIRTH_DT_TM, sex_cd, race, ethnicity)
    ) %>%
    #distinct() %>%
    # No change
    mutate(
        origin = "encounter_history.xlsx"
    )

FHP_encounters <- FHP_raw %>%
    # 86576 rows
    distinct() %>%
    # 44346 rows
    select(
        !c(NAME_FIRST, NAME_LAST, BIRTH_DT_TM, sex_cd, race, ethnicity)
    ) %>%
    #distinct() %>%
    # no change
    mutate(
        origin = "FHPMatchedtoEMRMatchedtoChante_reduced.xlsx"
    )


```






