---
title: "1 Prepping Datasets for Deduplication"
author: "Daniel P. Hall Riggins, MD"
date: "9/11/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(arrow)
library(readxl)
library(tidyverse)
```

```{r message=FALSE, warning=FALSE}
FHP_raw <- read_xlsx(
    "mrc_data/FHPMatchedtoEMRMatchedtoChante_reduced.xlsx",
    sheet = "EncounterdatawithChante",
    na = "NULL"
)

deaths_raw <- read_xlsx(
    "mrc_data/MatchingtoMEdata.xlsx", 
    na = "NULL"
)

claims_raw <- read_xlsx(
    "mrc_data/Rectified_FHSP_CC_20201102.xlsx",
    col_types = c("numeric", "text")
)

alerts_raw <- read_xlsx(
    "mrc_data/20201023AlertList.xlsx"
)

casework_raw <- read_xlsx(
    "mrc_data/Unencrypted_CCHreport.xlsx",
    na = "NA"
)
```

```{r functions}
dedupe_prep <- function(source, columns, origin) {
    print(
        paste0(
            "Initial number of records is ",
            nrow(source)
        )
    )
    distinct1 <- distinct(source)
    print(
        paste0(
            "Which reduces to ",
            nrow(distinct1),
            " when disinct() is first run"
        )
    )
    select2 <- select({{distinct1}}, {{columns}})
    distinct3 <- distinct(select2)
    print(
        paste0(
            "Which reduces to ",
            nrow(distinct3),
            " when disinct() is run after selecting columns of interest"
        )
    )
    mutate4 <- mutate(
        distinct3,
        origin = origin
    )
    return(mutate4)
}
```


```{r FHP people prep}
FHP_people <- dedupe_prep(
    source = FHP_raw,
    columns = c(person_id, cmrn_id, rin_cc, NAME_FIRST, NAME_LAST, BIRTH_DT_TM, sex_cd, race, ethnicity),
    origin = "FHPMatchedtoEMRMatchedtoChante_reduced.xlsx"
)
```
```{r}
deaths_people <- dedupe_prep(
    source = deaths_raw,
    columns = everything(),
    origin = "MatchingtoMEdata.xlsx"
)
```
```{r}
claims_people <- dedupe_prep(
    source = claims_raw,
    columns = rin_cc,
    origin = "Rectified_FHSP_CC_20201102.xlsx"
)
```

```{r}
alerts_people <- dedupe_prep(
    source = alerts_raw,
    columns = c(name, mrn, cmrn),
    origin = "20201023AlertList.xlsx"
) %>% filter(
    !(is.na(name)) 
)
```
```{r}
casework_people <- dedupe_prep(
    source = casework_raw,
    columns = c("Client ID", "Legacy ID", "Client Name"),
    origin = "Unencrypted_CCHreport.xlsx"
)
```

```{r}

history_encounters <- history_raw %>%
    # 145490 observations
    #distinct() %>%
    # No change
    select(
        !c(BIRTH_DT_TM, sex_cd, race, ethnicity)
    ) %>%
    #distinct() %>%
    # No change
    mutate(
        origin = "encounter_history.xlsx"
    )

FHP_encounters <- FHP_raw %>%
    # 86576 rows
    distinct() %>%
    # 44346 rows
    select(
        !c(NAME_FIRST, NAME_LAST, BIRTH_DT_TM, sex_cd, race, ethnicity)
    ) %>%
    #distinct() %>%
    # no change
    mutate(
        origin = "FHPMatchedtoEMRMatchedtoChante_reduced.xlsx"
    )


```






