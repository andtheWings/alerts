---
title: "1 Prepping Datasets for Deduplication and Merging"
author: "Daniel P. Hall Riggins, MD"
date: "9/11/2021"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(readxl)
library(RMariaDB)
library(tidyverse)
```

"MatchingtoMEdata" and "Rectified_FHSP_CC_20201102" do not need any prep

```{r message=FALSE, warning=FALSE}
history_raw <- read_xlsx("mrc_data/encounter history.xlsx", na = "NULL")
FHP_raw <- read_xlsx("mrc_data/FHPMatchedtoEMRMatchedtoChante_reduced.xlsx", na = "NULL")
deaths_raw <- read_xlsx("mrc_data/MatchingtoMEdata.xlsx", na = "NULL")
diagnoses_raw <- read_xlsx("mrc_data/Rectified_FHSP_CC_20201102.xlsx", col_types = c("numeric", "text"))
```

```{r people prep}
history_people <- history_raw %>%
    # 145490 observations
    #distinct() %>%
    # No change
    select(
        person_id, cmrn_id, rin_cc, BIRTH_DT_TM, sex_cd, race, ethnicity
    ) %>%
    distinct() %>%
    # 4766 observations
    mutate(
        origin = "encounter_history.xlsx"
    )

FHP_people <- FHP_raw %>%
    # 86576 rows
    distinct() %>%
    # 44346 rows
    select(
        person_id, cmrn_id, rin_cc, NAME_FIRST, NAME_LAST, BIRTH_DT_TM, sex_cd, race, ethnicity
    ) %>%
    distinct() %>%
    # 4768 rows
    mutate(
        origin = "FHPMatchedtoEMRMatchedtoChante_reduced.xlsx"
    )

people <- history_people %>%
    full_join(
        FHP_people,
        by = c("person_id", "cmrn_id", "rin_cc", "sex_cd", "BIRTH_DT_TM", "race", "ethnicity")
    ) %>%
    full_join(
        deaths_raw, 
        by = c(
            "person_id" = "Person_ID",
            "rin_cc" = "RIN_CC",
            "NAME_FIRST" = "DECEDENT_FIRST_NAME",
            "NAME_LAST" = "DECEDENT_LAST_NAME",
            "BIRTH_DT_TM" = "DECEDENT_DOB"
        )
    )

pos_dups <- people %>%
    group_by(BIRTH_DT_TM) %>%
    summarise(count = n()) %>%
    filter(count > 1)

people <- people %>%
    mutate(
        possible_dupe = BIRTH_DT_TM %in% pos_dups$BIRTH_DT_TM
    )
```

```{r init people in dolt}
con <- dbConnect(MariaDB(),
                 dbname = 'mrc_data',
                 host = '127.0.0.1',
                 port = 3306,
                 user = 'root')

dbWriteTable(con, "people", people, overwrite = TRUE)
```


```{r}

history_encounters <- history_raw %>%
    # 145490 observations
    #distinct() %>%
    # No change
    select(
        !c(BIRTH_DT_TM, sex_cd, race, ethnicity)
    ) %>%
    #distinct() %>%
    # No change
    mutate(
        origin = "encounter_history.xlsx"
    )

FHP_encounters <- FHP_raw %>%
    # 86576 rows
    distinct() %>%
    # 44346 rows
    select(
        !c(NAME_FIRST, NAME_LAST, BIRTH_DT_TM, sex_cd, race, ethnicity)
    ) %>%
    #distinct() %>%
    # no change
    mutate(
        origin = "FHPMatchedtoEMRMatchedtoChante_reduced.xlsx"
    )


```






